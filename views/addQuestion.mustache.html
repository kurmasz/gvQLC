<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Quiz Question</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        textarea { width: 100%; font-size: 14px; margin-bottom: 10px; display: block; }
        button { padding: 10px 20px; background: #007acc; color: white; border: none; cursor: pointer; margin-right: 10px; }
        button:hover { background: #005a9e; }
        .code-area { width: 100%; height: 120px; font-family: monospace; background: #f4f4f4; padding: 10px; border-radius: 5px; }
        .optional { color: #666; font-style: italic; }
        #suggestions { 
            position: absolute; 
            background: white;
            color: red;
            border: 1px solid #ddd; 
            max-height: 200px; 
            overflow-y: auto; 
            z-index: 1000;
            display: none;
            width: 100%;
            box-sizing: border-box;
        }
        .suggestion-item {
            padding: 8px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        .suggestion-item:hover {
            background-color: #f0f0f0;
        }
        #question-container {
            position: relative;
        }
        .container-flex {
            display: flex;
            justify-content: space-between;
        }
        .contrast {
            background-color: black;
            color: lightblue;
        }
        .contrast p, .contrast h1, .contrast textarea, .contrast div {
            background-color: black;
            color: lightblue;
        }
        .dark {
            background-color: black;
            color: white;
        }
        .dark p, .dark h1, .dark textarea, .dark div {
            background-color: black;
            color: white;
        }
        .dark.contrast {
            background-color: black;
            color: lightblue;
        }
        .dark.contrast p, .dark.contrast h1, .dark.contrast textarea, .dark.contrast div {
            background-color: black;
            color: lightblue;
        }
    </style>
</head>
<body id="body">
    <h1 class="container-flex" id='addQuizQuestionTitle'>
        <span>Add a Quiz Question</span>
        <span>
            <button id="darkModeButton" onclick="toggleDark()">Dark Mode</button>
            <button id="highContrastButton" onclick="toggleContrast()">High Contrast</button>
        </span>
    </h1>

    <p><strong>Edit Highlighted Code:</strong></p>
    <textarea id="codeBlock" class="code-area">{{selectedText}}</textarea>
    <button id="copyButton" onclick="copyAndPasteCode()">Copy & Paste Code</button>
    
    <div id="question-container">
        <p><strong>Add Your Question:</strong></p>
        <textarea id="question" placeholder="Type your personalized question here..." rows="4"></textarea>
        <div id="suggestions"></div>
    </div>
    
    <p><strong>Add Answer (Optional):</strong></p>
    <textarea id="answer" placeholder="Type the answer to your question (optional)..." rows="4"></textarea>

    <p><strong>AI Output:</strong></p>
    <textarea id="aiOutput" placeholder="No AI Output" rows="4"></textarea>
    <p id="displayMode" style="display: none;">{{darkMode}} {{contrastMode}}</p>

    <button id="submitButton" onclick="submitPersonalizedQuestion()">Submit</button>
    <button id="aiButton" onclick="aiSuggestQuestion()">AI Generate</button>
    <button id="acceptAI" onclick="acceptOutput()">Use AI Output</button>
    
    <script>
        const vscode = acquireVsCodeApi();
        let currentInput = '';
        let activeSuggestionIndex = -1;

        // Setup question textarea event listeners
        const questionInput = document.getElementById('question');
        const suggestionsContainer = document.getElementById('suggestions');

        questionInput.addEventListener('input', function(e) {
            currentInput = e.target.value.toLowerCase();
            showSuggestions();
        });

        questionInput.addEventListener('keydown', function(e) {
            const suggestions = document.querySelectorAll('.suggestion-item');
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                activeSuggestionIndex = Math.min(activeSuggestionIndex + 1, suggestions.length - 1);
                highlightSuggestion();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                activeSuggestionIndex = Math.max(activeSuggestionIndex - 1, -1);
                highlightSuggestion();
            } else if (e.key === 'Enter' && activeSuggestionIndex >= 0) {
                e.preventDefault();
                selectSuggestion(suggestions[activeSuggestionIndex]);
            } else if (e.key === 'Escape') {
                hideSuggestions();
            }
        });

        function showSuggestions() {
            if (!currentInput) {
                hideSuggestions();
                return;
            }

            const filtered = {{{existingQuestions}}}.filter(q => 
                q && q.toLowerCase().includes(currentInput))
                .slice(0, 5);
            console.log(filtered);
            console.log("test");
            if (filtered.length === 0) {
                hideSuggestions();
                return;
            }

            suggestionsContainer.innerHTML = filtered.map(q => {
                const escapedText = q.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                return '<div class="suggestion-item">' + escapedText + '</div>';
            }).join('');

            document.querySelectorAll('.suggestion-item').forEach((item, index) => {
                item.addEventListener('click', () => selectSuggestion(item));
            });

            suggestionsContainer.style.display = 'block';
            activeSuggestionIndex = -1;
        }

        function hideSuggestions() {
            suggestionsContainer.style.display = 'none';
            activeSuggestionIndex = -1;
        }

        function highlightSuggestion() {
            const suggestions = document.querySelectorAll('.suggestion-item');
            suggestions.forEach((item, index) => {
                if (index === activeSuggestionIndex) {
                    item.style.backgroundColor = '#007acc';
                    item.style.color = 'white';
                } else {
                    item.style.backgroundColor = '';
                    item.style.color = '';
                }
            });
        }

        function selectSuggestion(suggestionElement) {
            questionInput.value = suggestionElement.textContent;
            hideSuggestions();
            questionInput.focus();
        }

        function copyAndPasteCode() {
            const codeTextArea = document.getElementById('codeBlock');
            const questionArea = document.getElementById('question');
            const existingContent = questionArea.value.trim();
            
            const selectedCode = codeTextArea.value.substring(
                codeTextArea.selectionStart,
                codeTextArea.selectionEnd
            );
            
            const codeToInsert = selectedCode || codeTextArea.value;
            const formattedCode = "~~~\n" + codeToInsert + "\n~~~";

            if (existingContent) {
                questionArea.value = existingContent + "\n\n" + formattedCode;
            } else {
                questionArea.value = formattedCode;
            }
        }

        function submitPersonalizedQuestion() {
            const question = document.getElementById('question').value;
            const answer = document.getElementById('answer').value;
            const editedCode = document.getElementById('codeBlock').value;
            
            if (question.trim() === '') {
                alert('Question cannot be empty!');
                return;
            }

            vscode.postMessage({ 
                type: 'submitQuestion', 
                question, 
                answer, 
                editedCode 
            });
        }

        function acceptOutput() {
            const aiArea = document.getElementById('aiOutput');
            const questionArea = document.getElementById('question');
            const answerArea = document.getElementById('answer');

            if (aiArea.value != '') {
                var output = aiArea.value;
                var tokens = output.split("**Answer:** ");
                questionArea.value = tokens[0];
                answerArea.value = "**Answer:** " + tokens[1];
            }
        }

        // AI Suggestion function - sends request to backend
        function aiSuggestQuestion() {
            const codeTextArea = document.getElementById('codeBlock');
            const aiArea = document.getElementById('aiOutput');
            aiArea.value = "Generating content...";
            
            try {
                vscode.postMessage({ 
                    type: 'generateQuestion', 
                    code: codeTextArea.value 
                });
            } catch (error) {
                console.error("Error requesting AI generation:", error);
                aiArea.value = "Error generating content";
            }
        }
        
        // Listen for AI response from extension backend
        window.addEventListener('message', event => {
            const message = event.data;
            if (message.type === 'aiResponse') {
                const aiArea = document.getElementById('aiOutput');
                aiArea.value = message.content;
            } else if (message.type === 'aiError') {
                const aiArea = document.getElementById('aiOutput');
                aiArea.value = "Error: " + message.error;
            }
        });

    </script>
    <script>
        var currStyle = document.getElementById('body');
        var darkMode = document.getElementById('displayMode');
        var tokens = darkMode.innerHTML.split(" ");
        if (tokens[0] == 'dark') {
            currStyle.className = 'dark';
        } else {
            currStyle.className = 'normal';
        }
        if (tokens[1] == 'contrast') {
            currStyle.className = `${currStyle.className} contrast`;
        } else {
            currStyle.className = `${currStyle.className} normal`;
        }

        function toggleDark() {
            var currStyle = document.getElementById('body');
            var displayMode = document.getElementById('displayMode');
            var tokens = displayMode.innerHTML.split(" ");
            if (tokens[0] == 'dark') {
                currStyle.className = `normal ${tokens[1]}`;
                displayMode.innerHTML = `normal ${tokens[1]}`;
                vscode.postMessage({type: "alterUserSettings", darkMode: "normal", contrastMode: tokens[1]});
            } else {
                currStyle.className = `dark ${tokens[1]}`;
                displayMode.innerHTML = `dark ${tokens[1]}`;
                vscode.postMessage({type: "alterUserSettings", darkMode: 'dark', contrastMode: tokens[1]});
            }
        }

        function toggleContrast() {
            var currStyle = document.getElementById('body');
            var displayMode = document.getElementById('displayMode');
            var tokens = displayMode.innerHTML.split(" ");
            if (tokens[1] == 'contrast') {
                currStyle.className = `${tokens[0]} normal`;
                displayMode.innerHTML = `${tokens[0]} normal`;
                vscode.postMessage({type: "alterUserSettings", darkMode: tokens[0], contrastMode: 'normal'});
            } else {
                currStyle.className = `${tokens[0]} contrast`;
                displayMode.innerHTML = `${tokens[0]} contrast`;
                vscode.postMessage({type: "alterUserSettings", darkMode: tokens[0], contrastMode: 'contrast'});
            }
        }
    </script>
    <script>
        var currStyle = document.getElementById('body');
        var darkMode = document.getElementById('displayMode');
        var tokens = darkMode.innerHTML.split(" ");
        if (tokens[0] == 'dark') {
            currStyle.className = 'dark';
        } else {
            currStyle.className = 'normal';
        }
        if (tokens[1] == 'contrast') {
            currStyle.className = `${currStyle.className} contrast`;
        } else {
            currStyle.className = `${currStyle.className} normal`;
        }

        function toggleDark() {
            var currStyle = document.getElementById('body');
            var displayMode = document.getElementById('displayMode');
            var tokens = displayMode.innerHTML.split(" ");
            if (tokens[0] == 'dark') {
                currStyle.className = `normal ${tokens[1]}`;
                displayMode.innerHTML = `normal ${tokens[1]}`;
                vscode.postMessage({type: "alterUserSettings", darkMode: "normal", contrastMode: tokens[1]});
            } else {
                currStyle.className = `dark ${tokens[1]}`;
                displayMode.innerHTML = `dark ${tokens[1]}`;
                vscode.postMessage({type: "alterUserSettings", darkMode: 'dark', contrastMode: tokens[1]});
            }
        }

        function toggleContrast() {
            var currStyle = document.getElementById('body');
            var displayMode = document.getElementById('displayMode');
            var tokens = displayMode.innerHTML.split(" ");
            if (tokens[1] == 'contrast') {
                currStyle.className = `${tokens[0]} normal`;
                displayMode.innerHTML = `${tokens[0]} normal`;
                vscode.postMessage({type: "alterUserSettings", darkMode: tokens[0], contrastMode: 'normal'});
            } else {
                currStyle.className = `${tokens[0]} contrast`;
                displayMode.innerHTML = `${tokens[0]} contrast`;
                vscode.postMessage({type: "alterUserSettings", darkMode: tokens[0], contrastMode: 'contrast'});
            }
        }
    </script>
</body>
</html>