<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Quiz Question</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        textarea { width: 100%; font-size: 14px; margin-bottom: 10px; display: block; }
        button { padding: 10px 20px; background: #007acc; color: white; border: none; cursor: pointer; margin-right: 10px; }
        button:hover { background: #005a9e; }
        .code-area { width: 100%; height: 120px; font-family: monospace; background: #f4f4f4; padding: 10px; border-radius: 5px; }
        .optional { color: #666; font-style: italic; }
        #suggestions { 
            position: absolute; 
            background: white;
            color: red;
            border: 1px solid #ddd; 
            max-height: 200px; 
            overflow-y: auto; 
            z-index: 1000;
            display: none;
            width: 100%;
            box-sizing: border-box;
        }
        .suggestion-item {
            padding: 8px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        .suggestion-item:hover {
            background-color: #f0f0f0;
        }
        #question-container {
            position: relative;
        }
        .contrast {
            background-color: yellow;
            color: blue;
        }
        .contrast p, .contrast h1, .contrast textarea, .contrast div {
            background-color: yellow;
            color: blue;
        }
        .dark {
            background-color: black;
            color: white;
        }
        .dark p, .dark h1, .dark textarea, .dark div {
            background-color: black;
            color: white;
        }
    </style>
</head>
<body id="body">
    <button id="darkModeButton" onclick="toggleDark()">Dark Mode</button>
    <button id="highContrastButton" onclick="toggleContrast()">High Contrast</button>
    <h1 id='addQuizQuestionTitle'>Add a Quiz Question</h1>

    <p><strong>Edit Highlighted Code:</strong></p>
    <textarea id="codeBlock" class="code-area">{{selectedText}}</textarea>
    <button onclick="copyAndPasteCode()">Copy & Paste Code</button>
    
    <div id="question-container">
        <p><strong>Add Your Question:</strong></p>
        <textarea id="question" placeholder="Type your personalized question here..." rows="4"></textarea>
        <div id="suggestions"></div>
    </div>
    
    <p><strong>Add Answer (Optional):</strong></p>
    <textarea id="answer" placeholder="Type the answer to your question (optional)..." rows="4"></textarea>

    <p><strong>AI Output:</strong></p>
    <textarea id="aiOutput" placeholder="No AI Output" rows="4"></textarea>
    <p id="fileContent" style="display: none;">{{fullFileContent}}</p>
    <p id="apiKey" style="display: none;">{{apiKey}}</p>
    <p id="displayMode" style="display: none;">{{darkMode}} {{contrastMode}}</p>

    <button id="submitButton" onclick="submitPersonalizedQuestion()">Submit</button>
    <button id="aiButton">AI Generate</button>
    <button id="acceptAI" onclick="acceptOutput()">Fill from AI Output</button>
    
    <script>
        const vscode = acquireVsCodeApi();
        let currentInput = '';
        let activeSuggestionIndex = -1;

        // Setup question textarea event listeners
        const questionInput = document.getElementById('question');
        const suggestionsContainer = document.getElementById('suggestions');

        questionInput.addEventListener('input', function(e) {
            currentInput = e.target.value.toLowerCase();
            showSuggestions();
        });

        questionInput.addEventListener('keydown', function(e) {
            const suggestions = document.querySelectorAll('.suggestion-item');
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                activeSuggestionIndex = Math.min(activeSuggestionIndex + 1, suggestions.length - 1);
                highlightSuggestion();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                activeSuggestionIndex = Math.max(activeSuggestionIndex - 1, -1);
                highlightSuggestion();
            } else if (e.key === 'Enter' && activeSuggestionIndex >= 0) {
                e.preventDefault();
                selectSuggestion(suggestions[activeSuggestionIndex]);
            } else if (e.key === 'Escape') {
                hideSuggestions();
            }
        });

        function showSuggestions() {
            if (!currentInput) {
                hideSuggestions();
                return;
            }

            const filtered = {{{existingQuestions}}}.filter(q => 
                q && q.toLowerCase().includes(currentInput))
                .slice(0, 5);
            console.log(filtered);
            console.log("test");
            if (filtered.length === 0) {
                hideSuggestions();
                return;
            }

            suggestionsContainer.innerHTML = filtered.map(q => {
                const escapedText = q.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                return '<div class="suggestion-item">' + escapedText + '</div>';
            }).join('');

            document.querySelectorAll('.suggestion-item').forEach((item, index) => {
                item.addEventListener('click', () => selectSuggestion(item));
            });

            suggestionsContainer.style.display = 'block';
            activeSuggestionIndex = -1;
        }

        function hideSuggestions() {
            suggestionsContainer.style.display = 'none';
            activeSuggestionIndex = -1;
        }

        function highlightSuggestion() {
            const suggestions = document.querySelectorAll('.suggestion-item');
            suggestions.forEach((item, index) => {
                if (index === activeSuggestionIndex) {
                    item.style.backgroundColor = '#007acc';
                    item.style.color = 'white';
                } else {
                    item.style.backgroundColor = '';
                    item.style.color = '';
                }
            });
        }

        function selectSuggestion(suggestionElement) {
            questionInput.value = suggestionElement.textContent;
            hideSuggestions();
            questionInput.focus();
        }

        function copyAndPasteCode() {
            const codeTextArea = document.getElementById('codeBlock');
            const questionArea = document.getElementById('question');
            const existingContent = questionArea.value.trim();
            
            const selectedCode = codeTextArea.value.substring(
                codeTextArea.selectionStart,
                codeTextArea.selectionEnd
            );
            
            const codeToInsert = selectedCode || codeTextArea.value;
            const formattedCode = "~~~\n" + codeToInsert + "\n~~~";

            if (existingContent) {
                questionArea.value = existingContent + "\n\n" + formattedCode;
            } else {
                questionArea.value = formattedCode;
            }
        }

        function submitPersonalizedQuestion() {
            const question = document.getElementById('question').value;
            const answer = document.getElementById('answer').value;
            const editedCode = document.getElementById('codeBlock').value;
            
            if (question.trim() === '') {
                alert('Question cannot be empty!');
                return;
            }

            vscode.postMessage({ 
                type: 'submitQuestion', 
                question, 
                answer, 
                editedCode 
            });
        }

        function acceptOutput() {
            const aiArea = document.getElementById('aiOutput');
            const questionArea = document.getElementById('question');
            const answerArea = document.getElementById('answer');

            if (aiArea.value != '') {
                var output = aiArea.value;
                var tokens = output.split("**Answer:** ");
                questionArea.value = tokens[0];
                answerArea.value = "**Answer:** " + tokens[1];
            }
        }

    </script>

    <script type="module">
        const { GoogleGenAI } = await import('https://esm.run/@google/genai');
        
        const apiKeyArea = document.getElementById('apiKey');
        const aiArea = document.getElementById('aiOutput');
        const fileContents = document.getElementById('fileContent').value;
        const codeTextArea = document.getElementById('codeBlock');

        var genai = undefined;
        try {
            genai = new GoogleGenAI({apiKey: apiKeyArea.innerHTML});
        } catch (error) {
            console.log("Error calling Gemini API:", error);
            aiArea.value = "Invalid API Key, please use 'Set My API Key' command";
        }

        async function aiSuggestQuestion() {
            if (!genai) {
                aiArea.value = "Invalid API Key, please use 'Set My API Key' command";
                return;
            }
            try {
                aiArea.value = "Generating content...";
                /*
                const file = await genai.files.upload({
                    name: "contextFile",
                    contents: fileContents,
                    mimeType: 'text/plain'
                });

                let fileInfo = await ai.files.get({ name: uploadResponse.name });
                while (fileInfo.state === "PROCESSING") {
                    await new Promise((resolve) => setTimeout(resolve, 1000));
                    fileInfo = await ai.files.get({ name: uploadResponse.name });
                };
                */

                var contents = 
                `You are an expert programming flashcard generator.

                Analyze the provided **CONTEXT** and **CODE**.
                Your task is to create *one* insightful, short-form question and its correct answer that specifically tests understanding of a *key function, concept, or potential bug* within the **CODE**, considering the surrounding context.

                The response **MUST** adhere to the following strict format, with bolding and prefixes exactly as shown:

                **Question:** [The short, focused question]
                **Answer:** [The concise, correct explanation or result]

                **CONTEXT:**
                ${fileContents}

                **CODE:**
                ${codeTextArea.value}`;

                const response = await genai.models.generateContent({
                    model: "gemini-2.5-flash",
                    contents: contents
                });
                aiArea.value = response.text;
            } catch (error) {
                console.log("Error calling Gemini API:", error);
                questionArea.value = "Error generating content";
            }
        }
        const aiButton = document.getElementById('aiButton');
        aiButton.addEventListener('click', aiSuggestQuestion);
    </script>
    <script>
        var currStyle = document.getElementById('body');
        var darkMode = document.getElementById('displayMode');
        var tokens = darkMode.innerHTML.split(" ");
        if (tokens[0] == 'dark') {
            currStyle.className = 'dark';
        } else {
            currStyle.className = 'normal';
        }
        if (tokens[1] == 'contrast') {
            currStyle.className = `${currStyle.className} contrast`;
        } else {
            currStyle.className = `${currStyle.className} normal`;
        }

        function toggleDark() {
            var currStyle = document.getElementById('body');
            var displayMode = document.getElementById('displayMode');
            var tokens = displayMode.innerHTML.split(" ");
            if (tokens[0] == 'dark') {
                currStyle.className = `normal ${tokens[1]}`;
                displayMode.innerHTML = `normal ${tokens[1]}`;
                vscode.postMessage({type: "alterUserSettings", darkMode: "normal", contrastMode: tokens[1]});
            } else {
                currStyle.className = `dark ${tokens[1]}`;
                displayMode.innerHTML = `dark ${tokens[1]}`;
                vscode.postMessage({type: "alterUserSettings", darkMode: 'dark', contrastMode: tokens[1]});
            }
        }

        function toggleContrast() {
            var currStyle = document.getElementById('body');
            var displayMode = document.getElementById('displayMode');
            var tokens = displayMode.innerHTML.split(" ");
            if (tokens[1] == 'contrast') {
                currStyle.className = `${tokens[0]} normal`;
                displayMode.innerHTML = `${tokens[0]} normal`;
                vscode.postMessage({type: "alterUserSettings", darkMode: tokens[0], contrastMode: 'normal'});
            } else {
                currStyle.className = `${tokens[0]} contrast`;
                displayMode.innerHTML = `${tokens[0]} contrast`;
                vscode.postMessage({type: "alterUserSettings", darkMode: tokens[0], contrastMode: 'contrast'});
            }
        }
    </script>
</body>
</html>