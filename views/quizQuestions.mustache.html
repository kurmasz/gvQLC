<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Quiz Questions</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color:rgb(255, 255, 255);
            color: black;
        }
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .controls-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        .search-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #007acc;
            color: white;
            position: sticky;
            top: 0;
        }
        textarea {
            width: 100%;
            height: 100px;
            font-size: 14px;
            border: 1px solid #ccc;
            padding: 8px;
            resize: vertical;
            box-sizing: border-box;
        }
        .code-area {
            background-color: #1e1e1e;
            color: #d4d4d4;
            font-family: monospace;
        }
        .question-area {
            background-color: #f9f9f9;
            color: #333;
            font-family: sans-serif;
        }
        button {
            padding: 8px 12px;
            margin: 2px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            font-weight: bold;
        }
        button:hover {
            opacity: 0.9;
        }
        #refreshBtn {
            background-color: #4CAF50;
            color: white;
        }
        #toggleSummaryBtn {
            background-color: #673AB7;
            color: white;
        }
        input[type="text"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 250px;
        }
        input[type="checkbox"] {
            transform: scale(1.2);
            margin-top: 5px;
        }
        #summaryTableContainer table th {
            background-color: #007acc;
            color: white;
        }
        #summaryTableContainer table td {
            border: 1px solid #ddd;
            padding: 8px;
        }
        .total-count {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        .pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
            gap: 10px;
            flex-wrap: wrap;
        }
        .pagination-controls {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        .page-btn {
            padding: 5px 10px;
            border: 1px solid #ddd;
            background-color: white;
            cursor: pointer;
            border-radius: 4px;
            min-width: 30px;
            text-align: center;
        }
        .page-btn:hover:not(.active):not(:disabled) {
            background-color: #f1f1f1;
        }
        .page-btn.active {
            background-color: #007acc;
            color: white;
            border-color: #007acc;
        }
        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .page-jump {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .page-jump input {
            width: 50px;
            padding: 5px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .rows-per-page {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .rows-per-page select {
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .filepath {
            color: blue;
            text-decoration: underline;
        }
        .contrast {
            background-color: black;
            color: lightblue;
        }
        .contrast p, .contrast h1, .contrast textarea, .contrast div .contrast input, .contrast label, .contrast td, .contrast .total-count {
            background-color: black;
            color: lightblue;
        }
        .contrast #search-container {
            background-color: white;
        }
        .contrast td:first-child {
            color: black;
        }
        .contrast .filepath {
            color: white;
            text-decoration: underline;
        }
        .contrast th, .contrast td {
            border: 1px solid white;
            padding: 12px;
            text-align: left;
        }
        .contrast #summaryTableContainer td{
            background-color: initial;
            color: black;
        }
        .dark {
            background-color: black;
            color: white;
        }
        .dark p, .dark h1, .dark textarea, .dark div, .dark input, .dark label, .dark td {
            background-color: black;
            color: white;
        }
        .dark #search-container {
            background-color: initial;
        }
        .dark td:first-child {
            color: black;
        }
        .dark .filepath {
            color: white;
            text-decoration: underline;
        }
        .dark th, .dark td {
            border: 1px solid white;
            padding: 12px;
            text-align: left;
        }
        .dark #summaryTableContainer td{
            background-color: initial;
            color: black;
        }
        .dark.contrast {
            background-color: black;
            color: lightblue;
        }
        .dark.contrast p, .dark.contrast h1, .dark.contrast textarea, .dark.contrast div .dark.contrast input, .dark.contrast label, .dark.contrast td, .dark.contrast .total-count {
            background-color: black;
            color: lightblue;
        }
        .dark.contrast #search-container {
            background-color: initial;
        }
        .dark.contrast td:first-child {
            color: black;
        }
        .dark.contrast .filepath {
            color: white;
            text-decoration: underline;
        }
    </style>
</head>
<body id="body">
    <div class="header-container">
        <h1>All Quiz Questions</h1>
        <div class="total-count">Total Questions: {{totalQuestions}}</div>
        <div>
            <button id="darkModeButton" onclick="toggleDark()">Dark Mode</button>
            <button id="contrastModeButton" onclick="toggleContrast()">High Contrast</button>
        </div>
        <p id="displayMode" style="display: none;">{{darkMode}} {{contrastMode}}</p>
    </div>

    <div class="controls-container">
        <button id="refreshBtn" onclick="refreshView()">Refresh View</button>
        <button id="toggleSummaryBtn" onclick="toggleSummaryTable()">Toggle Student Summary</button>
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="Search questions..." oninput="filterQuestions()">
            <span id="filterCount"></span>
        </div>
        <!-- <button id="exportBtn" onclick="exportQuiz()">Export Quiz</button> -->
    </div>

    {{{summaryTable}}}

    <table id="questionsTable">
        <thead>
            <tr>
                <th>#</th>
                <th style="width: 40%;">Highlighted Code</th>
                <th style="width: 40%;">Question</th>
                <th style="width: 20%;">File & Actions</th>
            </tr>
        </thead>
        <tbody id="questionsTableBody">
            {{{questionsTable}}}
        </tbody>
    </table>

    <div class="pagination-container">
        <div class="pagination-controls">
            <button class="page-btn" onclick="goToFirstPage()" title="First Page" id="firstPageBtn">&laquo;</button>
            <button class="page-btn" onclick="goToPreviousPage()" title="Previous Page" id="prevPageBtn">&lt;</button>
            <div id="pageNumbers" style="display: flex; gap: 5px;"></div>
            <button class="page-btn" onclick="goToNextPage()" title="Next Page" id="nextPageBtn">&gt;</button>
            <button class="page-btn" onclick="goToLastPage()" title="Last Page" id="lastPageBtn">&raquo;</button>
        </div>

        <div class="page-jump">
            <span>Go to:</span>
            <input type="number" id="pageJumpInput" min="1" value="1">
            <button onclick="jumpToPage()">Go</button>
            <span>of <span id="totalPagesDisplay">1</span></span>
        </div>

        <div class="rows-per-page">
            <label for="rowsPerPage">Rows per page:</label>
            <select id="rowsPerPage" onchange="changeRowsPerPage()">
                <option value="10">10</option>
                <option value="15" selected>15</option>
                <option value="25">25</option>
                <option value="50">50</option>
                <option value="100">100</option>
            </select>
        </div>
    </div>

    <script>
        const vscode = acquireVsCodeApi();
        const originalData = JSON.parse(JSON.stringify({{{originalData}}}));
        const questionLabels = JSON.parse('{{{questionLabels}}}');
        const totalQuestions = originalData.length;


        // Pagination variables
        let currentPage = 1;
        let rowsPerPage = 15;
        let totalPages = Math.ceil(totalQuestions / rowsPerPage);
        let filteredRows = [];
        let isFiltered = false;

        function toggleSummaryTable() {
            const container = document.getElementById('summaryTableContainer');
            container.style.display = container.style.display === 'none' ? 'block' : 'none';
        }

        // Initialize the table
        function initializeTable() {
            updatePaginationControls();
            renderPageNumbers();
            updateVisibleRows();
        }

        // Update which rows are visible based on current page
        function updateVisibleRows() {
            const rows = document.querySelectorAll('#questionsTableBody tr');
            const startIdx = (currentPage - 1) * rowsPerPage;
            const endIdx = startIdx + rowsPerPage;

            rows.forEach((row, index) => {
                if (isFiltered && !filteredRows.includes(index)) {
                    row.style.display = 'none';
                    return;
                }

                if (index >= startIdx && index < endIdx) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // Update pagination controls state
        function updatePaginationControls() {
            document.getElementById('firstPageBtn').disabled = currentPage === 1;
            document.getElementById('prevPageBtn').disabled = currentPage === 1;
            document.getElementById('nextPageBtn').disabled = currentPage === totalPages;
            document.getElementById('lastPageBtn').disabled = currentPage === totalPages;
            document.getElementById('pageJumpInput').value = currentPage;
            document.getElementById('totalPagesDisplay').textContent = totalPages;
        }

        // Render page number buttons
        function renderPageNumbers() {
            const container = document.getElementById('pageNumbers');
            container.innerHTML = '';

            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            if (startPage > 1) {
                const btn = document.createElement('button');
                btn.className = 'page-btn';
                btn.textContent = '1';
                btn.onclick = () => goToPage(1);
                container.appendChild(btn);

                if (startPage > 2) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    container.appendChild(ellipsis);
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                const btn = document.createElement('button');
                btn.className = 'page-btn' + (i === currentPage ? ' active' : '');
                btn.textContent = i;
                btn.onclick = () => goToPage(i);
                container.appendChild(btn);
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    container.appendChild(ellipsis);
                }

                const btn = document.createElement('button');
                btn.className = 'page-btn';
                btn.textContent = totalPages;
                btn.onclick = () => goToPage(totalPages);
                container.appendChild(btn);
            }
        }

        // Navigation functions
        function goToPage(page) {
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            updateVisibleRows();
            updatePaginationControls();
            renderPageNumbers();
        }

        function goToFirstPage() {
            goToPage(1);
        }

        function goToPreviousPage() {
            goToPage(currentPage - 1);
        }

        function goToNextPage() {
            goToPage(currentPage + 1);
        }

        function goToLastPage() {
            goToPage(totalPages);
        }

        function jumpToPage() {
            const input = document.getElementById('pageJumpInput');
            const page = parseInt(input.value);
            if (!isNaN(page) && page >= 1 && page <= totalPages) {
                goToPage(page);
            }
        }

        // Change rows per page
        function changeRowsPerPage() {
            rowsPerPage = parseInt(document.getElementById('rowsPerPage').value);
            totalPages = Math.ceil((isFiltered ? filteredRows.length : totalQuestions) / rowsPerPage);
            if (currentPage > totalPages) {
                currentPage = totalPages;
            }
            initializeTable();
        }

        // Filter questions based on search term
        function filterQuestions() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const rows = document.querySelectorAll('#questionsTableBody tr');
            filteredRows = [];

            if (searchTerm === '') {
                isFiltered = false;
                document.getElementById('filterCount').textContent = '';
            } else {
                isFiltered = true;
                rows.forEach((row, index) => {
                    const label = row.dataset.label.toLowerCase();
                    const file = row.dataset.file.toLowerCase();
                    const code = row.dataset.code.toLowerCase();
                    const question = row.dataset.question.toLowerCase();

                    if (label.includes(searchTerm) || file.includes(searchTerm) ||
                        code.includes(searchTerm) || question.includes(searchTerm)) {
                        filteredRows.push(index);
                    }
                });

                document.getElementById('filterCount').textContent = filteredRows.length > 0
                    ? `${filteredRows.length} matches`
                    : 'No matches';
            }

            totalPages = Math.ceil((isFiltered ? filteredRows.length : totalQuestions) / rowsPerPage);
            currentPage = 1;
            initializeTable();
        }

        function copyQuestionText(index) {
            const questionTextArea = document.getElementById('question-' + index);
            const selectedText = questionTextArea.value.substring(
                questionTextArea.selectionStart,
                questionTextArea.selectionEnd
            );
            const textToCopy = selectedText.length > 0 ? selectedText : questionTextArea.value;

            navigator.clipboard.writeText(textToCopy).then(() => {
                vscode.postMessage({
                    type: 'showInformationMessage',
                    message: 'Copied to clipboard: ' +
                        (selectedText.length > 0 ? 'Selected text' : 'Full question')
                });
            }).catch(err => {
                vscode.postMessage({
                    type: 'showErrorMessage',
                    message: 'Failed to copy text: ' + err
                });
            });
        }

        function refreshView() {
            vscode.postMessage({ type: 'refreshView' });
        }

        function saveChanges(index) {
            const updatedCode = document.getElementById('code-' + index).value;
            const updatedQuestion = document.getElementById('question-' + index).value;
            vscode.postMessage({ type: 'saveChanges', index, updatedCode, updatedQuestion });
        }

        function revertChanges(index) {
            document.getElementById('code-' + index).value = originalData[index].highlightedCode;
            document.getElementById('question-' + index).value = originalData[index].text;
            document.getElementById('exclude-' + index).checked = originalData[index].excludeFromQuiz;
        }

        function toggleExclude(index) {
            const excludeStatus = document.getElementById('exclude-' + index).checked;
            vscode.postMessage({ type: 'toggleExclude', index, excludeStatus });
        }

        function editQuestion(index) {
            vscode.postMessage({ type: 'editQuestion', index });
        }

        function deleteQuestion(index) {
            vscode.postMessage({ type: 'deleteQuestion', index });
        }

        function filterByName(displayName) {
            if (document.getElementById('searchInput').value === displayName.toLowerCase()) {
                document.getElementById('searchInput').value = "";
            }
            else {
                document.getElementById('searchInput').value = displayName.toLowerCase();
            }
            filterQuestions();
        }

        function openFileAt(index) {
            vscode.postMessage({ type: 'openFileAt', index });
        }

        // function exportQuiz() {
        //     vscode.postMessage({ type: 'exportQuiz' });
        // }

        function acceptOutput(index) {
            const aiArea = document.getElementById(`ai-${index}`);
            const questionArea = document.getElementById(`question-${index}`);
            //const answerArea = document.getElementById(`ai-${index}`);

            if (aiArea.value != '') {
                var output = aiArea.value;
                var tokens = output.split("**Answer:** ");
                questionArea.value = tokens[0];
                //answerArea.value = "**Answer:** " + tokens[1];
            }
        }

        function aiSuggestQuestion(index) {
            const codeTextArea = document.getElementById(`code-${index}`);
            const questionArea = document.getElementById(`question-${index}`);
            const filepath = document.getElementById(`filepath-${index}`);
            const aiArea = document.getElementById(`ai-${index}`);
            console.log(codeTextArea.value);
            aiArea.value = "Generating content...";
            aiArea.style = "display: block;";
            
            try {
                vscode.postMessage({ 
                    type: 'generateQuestion', 
                    code: codeTextArea.value,
                    filepath: filepath.textContent, 
                    index: index
                });
            } catch (error) {
                console.error("Error requesting AI generation:", error);
                aiArea.value = "Error generating content";
            }
        }

        function aiRephraseQuestion(index) {
            const codeTextArea = document.getElementById(`code-${index}`);
            const questionArea = document.getElementById(`question-${index}`);
            const filepath = document.getElementById(`filepath-${index}`);
            const aiArea = document.getElementById(`ai-${index}`);
            console.log(codeTextArea.value);
            aiArea.value = "Rephrasing question...";
            aiArea.style = "display: block;";
            
            try {
                vscode.postMessage({ 
                    type: 'rephraseQuestion', 
                    code: codeTextArea.value,
                    question: questionArea.value,
                    filepath: filepath.textContent,
                    index: index
                });
            } catch (error) {
                console.error("Error requesting AI generation:", error);
                aiArea.value = "Error generating content";
            }
        }
        
        // Listen for AI response from extension backend
        window.addEventListener('message', event => {
            const message = event.data;
            if (message.type === 'aiResponse') {
                const aiArea = document.getElementById(`ai-${message.index}`);
                aiArea.style = "display: block;";
                aiArea.value = message.content;
            } else if (message.type === 'aiError') {
                const aiArea = document.getElementById(`ai-${message.index}`);
                aiArea.style = "display: block;";
                aiArea.value = "Error: " + message.error;
            }
        });

        // Initialize the table when the page loads
        window.addEventListener('load', initializeTable);
    </script>
    <script>
        var currStyle = document.getElementById('body');
        var darkMode = document.getElementById('displayMode');
        var tokens = darkMode.innerHTML.split(" ");
        if (tokens[0] == 'dark') {
            currStyle.className = 'dark';
        } else {
            currStyle.className = 'normal';
        }
        if (tokens[1] == 'contrast') {
            currStyle.className = `${currStyle.className} contrast`;
        } else {
            currStyle.className = `${currStyle.className} normal`;
        }

        function toggleDark() {
            var currStyle = document.getElementById('body');
            var displayMode = document.getElementById('displayMode');
            var tokens = displayMode.innerHTML.split(" ");
            if (tokens[0] == 'dark') {
                currStyle.className = `normal ${tokens[1]}`;
                displayMode.innerHTML = `normal ${tokens[1]}`;
                vscode.postMessage({type: "alterUserSettings", darkMode: "normal", contrastMode: tokens[1]});
            } else {
                currStyle.className = `dark ${tokens[1]}`;
                displayMode.innerHTML = `dark ${tokens[1]}`;
                vscode.postMessage({type: "alterUserSettings", darkMode: 'dark', contrastMode: tokens[1]});
            }
        }

        function toggleContrast() {
            var currStyle = document.getElementById('body');
            var displayMode = document.getElementById('displayMode');
            var tokens = displayMode.innerHTML.split(" ");
            if (tokens[1] == 'contrast') {
                currStyle.className = `${tokens[0]} normal`;
                displayMode.innerHTML = `${tokens[0]} normal`;
                vscode.postMessage({type: "alterUserSettings", darkMode: tokens[0], contrastMode: 'normal'});
            } else {
                currStyle.className = `${tokens[0]} contrast`;
                displayMode.innerHTML = `${tokens[0]} contrast`;
                vscode.postMessage({type: "alterUserSettings", darkMode: tokens[0], contrastMode: 'contrast'});
            }
        }
    </script>
</body>
</html>